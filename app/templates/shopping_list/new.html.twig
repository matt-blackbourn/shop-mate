{% extends 'base.html.twig' %}

{% block title %}New Shopping List{% endblock %}

{% block body %}
<div class="container py-3">

    <h1 class="h4 mb-3">New shopping list</h1>

  {{ form_start(form) }}

    <!-- Add item button at top -->
    <button
        type="button"
        id="add-item"
        class="btn btn-primary w-100 mb-3"
    >
        <i class="bi bi-plus"></i> Add item
    </button>

    <div
        id="listItems"
        class="d-flex flex-column gap-2"
        data-prototype="{{ form_widget(form.listItems.vars.prototype)|e('html_attr') }}"
    >
        {% for itemForm in form.listItems %}
        <div class="card list-item collapsed">
            <div class="card-body p-2">

                <!-- Header -->
                <div class="d-flex align-items-center justify-content-between item-header">
                    <div class="fw-semibold food-label">
                        New item
                    </div>

                    <div class="d-flex align-items-center gap-2">
                        <button type="button" class="btn btn-sm btn-outline-danger remove-item">
                            <i class="bi bi-x"></i>
                        </button>
                    </div>
                </div>

                <!-- Collapsible body -->
                <div class="item-body mt-2">
                    {{ form_widget(itemForm.foodItem, { attr: { class: 'form-select form-select-sm food-select' } }) }}

                    <div class="d-flex align-items-center gap-2 mt-2">

                    <!-- Notes -->
                    <div class="flex-grow-1">
                        {{ form_widget(itemForm.notes, {
                            attr: {
                                class: 'form-control form-control-sm',
                                placeholder: 'Notes'
                            }
                        }) }}
                    </div>

                    <!-- Quantity controls -->
                    <div class="d-flex align-items-center gap-1 qty-control">
                        <button type="button" class="btn btn-sm btn-outline-secondary qty-down">âˆ’</button>

                        <span class="fw-semibold qty-display px-2">
                            {{ itemForm.quantity.vars.value ?? 1 }}
                        </span>

                        {{ form_widget(itemForm.quantity, {
                            attr: { class: 'd-none quantity-input', value: itemForm.quantity.vars.value ?? 1 }
                        }) }}

                        <button type="button" class="btn btn-sm btn-outline-secondary qty-up">+</button>
                    </div>

                </div>

                </div>

            </div>
        </div>
        {% endfor %}
        {% do form.listItems.setRendered %}
    </div>

    <!-- Form actions -->
    <div class="d-flex gap-2 mt-4">
        <button type="submit" class="btn btn-success flex-fill">Save</button>
        <a href="{{ path('app_home') }}" class="btn btn-outline-secondary flex-fill">Cancel</a>
    </div>

    {{ form_end(form) }}
</div>

<style>
.list-item.collapsed .item-body {
    display: none;
}
.list-item.collapsed .toggle-item i {
    transform: rotate(-90deg);
}
.toggle-item i {
    transition: transform 0.15s ease;
}
.item-header {
    cursor: pointer;
}
.item-header .food-label {
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
}
.qty-control .btn {
    padding: 0.25rem 0.4rem;
}
.ts-control {
    min-height: 38px;
    padding: 0.375rem 0.75rem;
}
</style>

<script>
const container = document.getElementById('listItems');
let index = {{ form.listItems|length }};

// Add new item at top
// Add new item at top
document.getElementById('add-item').addEventListener('click', () => {
    const prototype = container.dataset.prototype.replace(/__name__/g, index);
    index++;

    // Collapse existing items
    container.querySelectorAll('.list-item').forEach(i => {
        i.classList.remove('expanded');
        i.classList.add('collapsed');
    });

    const wrapper = document.createElement('div');
    wrapper.className = 'card list-item expanded';

    // Parse prototype safely
    const temp = document.createElement('div');
    temp.innerHTML = prototype;

    // Find the food select
    const select = temp.querySelector('select');

    // Ensure class exists for Tom Select
    select.classList.add('food-select');

    // Extract HTML
    const foodSelectHTML = select.outerHTML;

    wrapper.innerHTML = `
        <div class="card-body p-2">
            <div class="d-flex align-items-center justify-content-between item-header">
                <div class="fw-semibold food-label">New item</div>
                <div class="d-flex align-items-center gap-2">
                    <button type="button" class="btn btn-sm btn-outline-danger remove-item">
                        <i class="bi bi-x"></i>
                    </button>
                </div>
            </div>

            <div class="item-body mt-2">
                ${foodSelectHTML}

                <!-- Inline Notes + Quantity -->
                <div class="d-flex align-items-center gap-2 mt-2">
                    <div class="flex-grow-1">
                        <input type="text" class="form-control form-control-sm" placeholder="Notes">
                    </div>
                    <div class="d-flex align-items-center gap-1 qty-control">
                        <button type="button" class="btn btn-sm btn-outline-secondary qty-down">âˆ’</button>
                        <span class="fw-semibold qty-display px-2">1</span>
                        <input type="hidden" class="quantity-input" value="1">
                        <button type="button" class="btn btn-sm btn-outline-secondary qty-up">+</button>
                    </div>
                </div>
            </div>
        </div>
    `;

    container.prepend(wrapper);

    // ðŸ”¥ Tell Tom Select a new item was added
    document.dispatchEvent(new Event('collection:add'));

    container.addEventListener('change', e => {
        if(e.target.tagName === 'SELECT'){
            const select = e.target;
            const label = wrapper.querySelector('.food-label');
            label.textContent = select.options[select.selectedIndex]?.text || 'New item';
        }
    })
});



// Event delegation
container.addEventListener('change', e => {
    const item = e.target.closest('.list-item');
    if (!item) return;

    // Update food label when select changes
    if (e.target.classList.contains('food-select')) {
        const select = e.target;
        const label = item.querySelector('.food-label');
        label.textContent = select.options[select.selectedIndex]?.text || 'New item';
    }
});

container.addEventListener('click', e => {
    const item = e.target.closest('.list-item');
    if (!item) return;

    // Toggle expand/collapse when header clicked (ignore buttons)
    if (e.target.closest('.item-header') && !e.target.closest('button')) {
        item.classList.toggle('expanded');
        item.classList.toggle('collapsed');
    }

    // Remove item
    if (e.target.closest('.remove-item')) {
        item.remove();
    }

    // Quantity controls
    if (e.target.closest('.qty-up') || e.target.closest('.qty-down')) {
        const input = item.querySelector('.quantity-input');
        const display = item.querySelector('.qty-display');

        let value = parseInt(input.value || 1, 10);
        if (e.target.closest('.qty-up')) value++;
        if (e.target.closest('.qty-down')) value = Math.max(1, value - 1);

        input.value = value;
        display.textContent = value;
    }
});

// On page load: update all labels after DOM ready
document.addEventListener('DOMContentLoaded', () => {
    container.querySelectorAll('.list-item').forEach(item => {
        const select = item.querySelector('.food-select');
        const label = item.querySelector('.food-label');
        if (select && label) {
            label.textContent = select.options[select.selectedIndex]?.text || 'New item';
        }
    });
});

{# TOM select #}
document.addEventListener('DOMContentLoaded', () => {
    function initFoodSelect(context = document) {
        context.querySelectorAll('select.food-select').forEach(select => {
            if (select.tomselect) return; // prevent double-init

            const ts = new TomSelect(select, {
                create: false,
                maxItems: 1,
                preload: true,
                placeholder: 'Search foodâ€¦',
                allowEmptyOption: true,
                closeAfterSelect: true,
            });

            ts.focus();
            ts.open();
        });
    }

    // Init existing items
    initFoodSelect();

    // Handle Symfony collection add
    document.addEventListener('collection:add', (e) => {
        initFoodSelect(e.target);
    });
});

</script>
{% endblock %}
